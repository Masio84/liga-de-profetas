<!DOCTYPE html>
<html lang="es">

<head>

    <meta charset="UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Favicon -->
    <link rel="icon" type="image/png" href="assets/logo-original.png?v=2">
    <title>Liga de Profetas | Quiniela Deportiva</title>

    <link rel="stylesheet" href="style.css?v=2">

    <!-- GOOGLE FONTS -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Russo+One&family=Roboto:wght@300;400;700&display=swap"
        rel="stylesheet">

    <!-- jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="scripts/pdf_ticket.js"></script>

    <style>
        /* Override global body padding so empty space doesn't show under footer */
        body {
            padding-bottom: 0 !important;
        }
    </style>

</head>

<body>

    <!-- HERO SECTION -->
    <section class="hero-section">
        <div class="hero-container-flex">
            <!-- LOGO IZQUIERDA -->
            <div class="hero-logo-wrapper">
                <img src="assets/logo-original.png" alt="Liga de Profetas" class="hero-logo">
            </div>

            <!-- TEXTO CENTRO/DERECHA -->
            <div class="hero-text-wrapper">
                <h1 class="hero-title">PREDICE. PARTICIPA. GANA.</h1>
                <p class="hero-subtitle">
                    Demuestra tu visi√≥n futbolera en la Liga MX, predice los resultados de cada jornada y <span
                        style="color: var(--gold-primary); font-weight: bold;">¬°gana grandes premios en efectivo!</span>
                </p>
            </div>
        </div>
    </section>

    <!-- JORNADA BAR (Top Bar Container reused) -->
    <div class="top-bar-container">
        <div id="jornadaTitulo">CARGANDO...</div>
        <div id="jornadaFechas">...</div>
    </div>

    <!-- BOLSA DE PREMIOS -->
    <div class="pozo-container">
        <div class="pozo-box">
            <div class="pozo-title">
                ü•á Premio 1er Lugar
            </div>
            <div id="premioPrimero" class="pozo-amount">
                $0
            </div>
        </div>
        <div class="pozo-box">
            <div class="pozo-title">
                ü•à Premio 2do Lugar
            </div>
            <div id="premioSegundo" class="pozo-amount">
                $0
            </div>
        </div>
    </div>





    <div class="container main-layout">

        <!-- COLUMNA IZQUIERDA: PARTIDOS -->
        <div class="matches-column">
            <h2>1. Arma tu Quiniela</h2>

            <!-- TIP: DOBLES Y TRIPLES -->
            <div id="tip-dobles" style="
                background: linear-gradient(90deg, rgba(197, 160, 89, 0.1), rgba(0, 51, 0, 0.2));
                border-left: 4px solid var(--gold-primary);
                padding: 15px;
                margin-bottom: 20px;
                border-radius: 4px;
                display: flex;
                align-items: start;
                gap: 15px;
                border: 1px solid rgba(197, 160, 89, 0.2);
            ">
                <div style="font-size: 24px;">üí°</div>
                <div>
                    <strong style="color: var(--gold-primary); font-size: 1.1em;">¬°Aumenta tus posibilidades!</strong>
                    <p style="margin: 5px 0 0; font-size: 0.95em; color: #cbd5e1;">
                        Puedes seleccionar <strong>2 o 3 opciones</strong> en un mismo partido (Dobles y Triples).
                        <br>
                        <span style="font-size: 0.85em; opacity: 0.8;">*El costo de la quiniela se ajustar√°
                            autom√°ticamente seg√∫n tus combinaciones.</span>
                    </p>
                </div>
            </div>

            <div id="matches"></div>
        </div>

        <!-- COLUMNA DERECHA: CARRITO -->
        <div class="sidebar-column">

            <!-- CARRITO DE COMPRAS (AHORA POR DEFECTO VISIBLE O PLACEHOLDER) -->
            <div id="carritoContainer" class="carrito-panel">
                <h3>üõí Tu Carrito</h3>
                <div id="carritoItems" class="carrito-items">
                    <!-- Items se agregan aqui o Mensaje Vacio -->
                    <div class="carrito-empty-message">Tu carrito est√° vac√≠o.<br>Agrega quinielas para continuar.</div>
                </div>

                <div class="carrito-total" style="margin-top: 15px; border-top: 1px solid #333; padding-top: 10px;">
                    <span>Total a Pagar:</span>
                    <span id="carritoTotal" style="color: #4ade80; float: right; font-weight: bold;">$0</span>
                </div>

                <button onclick="enviarCarrito()" class="btn-action btn-submit" style="font-size: 16px;">
                    üöÄ Enviar Todo
                </button>
            </div>

            <!-- BOTONES EXTRA -->
            <div style="text-align: center;">
                <button onclick="abrirModalParticipantes()" class="btn-secondary" style="width: 100%;">
                    üë• Ver Participantes
                </button>
            </div>


        </div>

    </div>

    <!-- STICKY USER PANEL (DATOS + COSTO) -->
    <div class="sticky-user-panel">

        <div class="input-row">
            <div class="form-group">
                <label>Tu Nombre</label>
                <input type="text" id="nombre" placeholder="Ej. Juan P√©rez">
            </div>
            <div class="form-group">
                <label>Celular (10 d√≠gitos)</label>
                <input type="tel" id="celular" placeholder="Ej. 5512345678">
            </div>
            <div class="form-group">
                <label>Referencia (Opcional)</label>
                <input type="text" id="referencia" placeholder="Clave rastreo / Folio">
            </div>
        </div>

        <div class="action-row">
            <div class="costo-display">
                <span class="costo-label">Costo Actual</span>
                <span id="costoActual" class="costo-amount">$0</span>
            </div>

            <div>
                <button id="btnAgregar" onclick="agregarAlCarrito()" class="btn-action btn-add">
                    üõí Agregar
                </button>
                <div style="text-align: center; margin-top: 5px;">
                    <a href="#" onclick="limpiarSeleccion()"
                        style="font-size: 12px; color: #ef4444; opacity: 0.8;">Limpiar</a>
                </div>
            </div>
        </div>

    </div>


    <!-- MODAL REGLAMENTO -->
    <div id="modalReglamento" class="modal">
        <div class="modal-content">
            <span class="cerrar" onclick="cerrarReglamento()">√ó</span>

            <div class="modal-header">
                <h2 class="modal-title">Reglamento R√°pido</h2>
            </div>

            <div class="rule-item">
                <div class="rule-icon">üèÜ</div>
                <div><strong>El Ganador:</strong> Ser√° quien tenga mayor cantidad de aciertos.</div>
            </div>

            <div class="rule-item">
                <div class="rule-icon">üí∞</div>
                <div><strong>Premios:</strong> El 70% de lo recaudado se reparte. <br>
                    <span style="color: gold;">1er Lugar: 80%</span> | <span style="color: silver;">2do Lugar:
                        20%</span>
                </div>
            </div>

            <div class="rule-item">
                <div class="rule-icon">‚õî</div>
                <div><strong>Partidos Suspendidos:</strong> Se consideran nulos para la quiniela.</div>
            </div>

            <div class="payment-box">
                <div style="margin-bottom: 5px;"><strong>Costo de participaci√≥n: $10 MXN</strong></div>
                <div>Transferencia a cuenta CLABE:</div>
                <span class="payment-highlight">728969000159916895</span>
                <div style="color: var(--gold-primary); font-weight: bold; margin-top: 5px;">Banco: Spin by Oxxo</div>
                <div style="font-size: 0.9em; margin-top: 8px; color: #aaa;">*Usa esta referencia al llenar tu quiniela
                </div>
            </div>

            <div class="modal-footer">
                <div class="btn-full-rules" onclick="abrirReglamentoCompleto()">
                    üìÑ Ver Reglamento Completo
                </div>
            </div>
        </div>
    </div>


    <!-- MODAL PARTICIPANTES -->
    <!-- MODAL PARTICIPANTES -->
    <div id="modalParticipantes" class="modal" style="display: none;">
        <div class="modal-content" style="width: 90%; max-width: 280px; padding: 15px;">
            <span class="close"
                onclick="document.getElementById('modalParticipantes').style.display='none'">&times;</span>

            <h2
                style="color: var(--gold-primary); text-align: center; margin-bottom: 5px; font-family: 'Russo One', sans-serif;">
                üë• LISTA DE PARTICIPANTES
            </h2>
            <p id="modalParticipantesSubtitle" style="text-align: center; color: #94a3b8; margin-bottom: 20px;">
                Cargando...
            </p>

            <!-- BUSCADOR COMPACTO -->
            <div style="margin-bottom: 15px; position: relative;">
                <span
                    style="position: absolute; left: 10px; top: 50%; transform: translateY(-50%); opacity: 0.5;">üîç</span>
                <input type="text" id="filtroParticipantes" placeholder="Buscar..." onkeyup="filtrarParticipantes()"
                    style="
                        width: 100%; 
                        padding: 8px 8px 8px 30px; 
                        background: #0f172a; 
                        border: 1px solid #334155; 
                        color: white; 
                        border-radius: 6px;
                        font-size: 14px;
                    ">
            </div>

            <div style="max-height: 400px; overflow-y: auto;">
                <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                    <thead
                        style="background: rgba(255, 255, 255, 0.05); color: var(--gold-primary); position: sticky; top: 0;">
                        <tr>
                            <th style="padding: 10px; text-align: center;">Folio</th>
                        </tr>
                    </thead>
                    <tbody id="tablaParticipantesBody">
                        <!-- Llenado din√°mico -->
                    </tbody>
                </table>
            </div>

            <div style="text-align: center; margin-top: 15px;">
                <button onclick="document.getElementById('modalParticipantes').style.display='none'" class="btn-action"
                    style="padding: 8px 25px; background: #334155; font-size: 0.9em;">
                    Cerrar
                </button>
            </div>

        </div>
    </div>


    <!-- MODAL PAGO -->
    <div id="modalPago" class="modal">
        <div class="modal-content" style="text-align: center;">
            <span class="cerrar" onclick="cerrarModalPago()">√ó</span>

            <div class="modal-header">
                <h2 class="modal-title">Confirmar Pago</h2>
            </div>

            <p style="font-size: 1.1em; color: #cbd5e1;">Finaliza tu participaci√≥n:</p>

            <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; margin: 20px 0;">
                <div style="font-size: 0.9em; color: #94a3b8; margin-bottom: 5px;">Total a Pagar</div>
                <div id="modalTotalPagar" style="font-size: 2.5em; font-weight: bold; color: #4ade80;">$0</div>
            </div>

            <div class="payment-box">
                <div style="margin-bottom: 10px; color:#cbd5e1;">Cuenta CLABE para transferencia:</div>

                <div style="color: var(--gold-primary); font-weight: bold; margin-bottom: 5px;">Banco: Spin by Oxxo
                </div>

                <div style="
                    display: flex; 
                    align-items: center; 
                    justify-content: center; 
                    gap: 10px; 
                    background: rgba(0,0,0,0.2); 
                    padding: 10px; 
                    border-radius: 6px; 
                    border: 1px dashed rgba(255,255,255,0.1);
                ">
                    <span id="clabeTexto" class="payment-highlight"
                        style="margin:0; font-size:1.4em; letter-spacing:1px; color:#fff;">728969000159916895</span>

                    <button onclick="copiarCLABE()" style="
                        background: rgba(74, 222, 128, 0.1); 
                        border: 1px solid #4ade80; 
                        color: #4ade80; 
                        border-radius: 6px; 
                        cursor: pointer; 
                        padding: 8px 12px;
                        font-size: 1.2em;
                        transition: all 0.2s;
                    " title="Copiar CLABE">
                        üìã
                    </button>
                </div>

                <div id="copiadoFeedback" style="
                    font-size: 0.9em; 
                    color: #4ade80; 
                    height: 20px; 
                    margin-top: 5px; 
                    opacity: 0; 
                    transition: opacity 0.3s; 
                    font-weight:bold;
                ">
                    ¬°Copiado al portapapeles!
                </div>

                <div style="font-size: 0.9em; margin-top: 10px; color: #94a3b8;">
                    *No olvides poner tu <strong>Referencia</strong> en el concepto de pago.
                </div>

                <div
                    style="margin-top: 20px; text-align: left; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 6px;">
                    <label
                        style="display: flex; align-items: start; gap: 10px; cursor: pointer; color: #cbd5e1; font-size: 0.9em;">
                        <input type="checkbox" id="checkLegal" style="margin-top: 4px;">
                        <span>
                            Declaro ser mayor de 18 a√±os y haber le√≠do y aceptado los
                            <a href="terminos.html" target="_blank" style="color: #00d4ff;">T√©rminos y Condiciones</a>.
                            No constituye un casino ni sistema de juegos de azar.bilidad y no un juego de azar.
                        </span>
                    </label>
                </div>
            </div>

            <div class="modal-footer" style="
                display: flex; 
                gap: 15px; 
                justify-content: center; 
                margin-top: 30px;
            ">
                <button onclick="cerrarModalPago()" style="
                    background: transparent; 
                    border: 1px solid #ef4444; 
                    color: #ef4444; 
                    padding: 12px 20px; 
                    border-radius: 8px; 
                    cursor: pointer; 
                    font-weight: bold;
                    transition: all 0.2s;
                ">
                    Cancelar
                </button>

                <button onclick="confirmarPagoYEnviar()" class="btn-action" style="
                    padding: 12px 30px; 
                    font-size: 1.1em;
                    background: linear-gradient(135deg, #22c55e, #16a34a);
                    box-shadow: 0 4px 15px rgba(34, 197, 94, 0.3);
                    border: none;
                ">
                    ‚úÖ Confirmar Env√≠o
                </button>
            </div>
        </div>
    </div>




    <script src="app.js?v=2"></script>

    <script>

        /* MODAL REGLAMENTO (SIMPLE) */
        function abrirReglamento() {
            document.getElementById("modalReglamento").style.display = "block";
        }
        function cerrarReglamento() {
            document.getElementById("modalReglamento").style.display = "none";
        }
        function abrirReglamentoCompleto() {
            window.location.href = "reglamento.html";
        }


        /* MODAL PARTICIPANTES */
        async function abrirModalParticipantes() {
            document.getElementById("modalParticipantes").style.display = "block";

            // Obtener jornada actual del header (un poco hacky pero usa la logica existente)
            // Lo ideal seria tener 'jornadaActualGlobal' en app.js.
            // Intentamos invocar la funcion global si existe
            if (typeof cargarParticipantes === 'function') {
                await cargarParticipantes();
            }
        }
        function cerrarModalParticipantes() {
            document.getElementById("modalParticipantes").style.display = "none";
        }


        /* BOLSA DE PREMIOS CALCULO */
        async function actualizarPozo() {
            try {
                const res = await fetch("/api/jornadas");
                const data = await res.json();

                // MISMA LOGICA que app.js para determinar cual mostrar (la proxima)
                const disponibles = data.jornadas.filter(j => j.estado === "DISPONIBLE");
                disponibles.sort((a, b) => a.numero - b.numero);
                const disponible = disponibles.length > 0 ? disponibles[0] : null;

                if (!disponible) return;

                const resPozo = await fetch(`/api/jornadas/${disponible.numero}/pozo`);
                const pozo = await resPozo.json();
                const premios = pozo.premios || { premioPrimero: 0, premioSegundo: 0 };

                document.getElementById("premioPrimero").innerText =
                    `$${premios.premioPrimero ? parseFloat(premios.premioPrimero).toLocaleString("en-US", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : "0.00"}`;

                document.getElementById("premioSegundo").innerText =
                    `$${premios.premioSegundo ? parseFloat(premios.premioSegundo).toLocaleString("en-US", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : "0.00"}`;

            } catch (error) {
                console.error("Error actualizando pozo:", error);
            }
        }
        actualizarPozo();

        /* HEADER LOGIC (SIMPLE + COUNTDOWN) */
        async function iniciarHeader() {
            try {
                const res = await fetch("/api/jornadas");
                const data = await res.json();
                const disponibles = data.jornadas.filter(j => j.estado === "DISPONIBLE");
                disponibles.sort((a, b) => a.numero - b.numero);
                const disponible = disponibles.length > 0 ? disponibles[0] : null;

                if (!disponible) {
                    const titulo = document.getElementById('jornadaTitulo');
                    if (titulo) titulo.textContent = "Sin Jornada Activa";
                    return;
                }

                // Global var hack for modal
                window.jornadaActivaNumero = disponible.numero;

                const titulo = document.getElementById('jornadaTitulo');
                if (titulo) titulo.textContent = `Jornada ${disponible.numero}`;

                const inicio = new Date(disponible.fechaInicio);
                const fin = new Date(disponible.fechaFin);
                const opciones = { day: 'numeric', month: 'long' };
                const textoFechas = `${inicio.toLocaleDateString('es-MX', opciones)} - ${fin.toLocaleDateString('es-MX', opciones)}`;
                const fechasEl = document.getElementById('jornadaFechas');
                if (fechasEl) fechasEl.textContent = textoFechas;

                // COUNTDOWN
                try {
                    const resMatches = await fetch(`/api/jornadas/${disponible.numero}/matches`);
                    const dataMatches = await resMatches.json();

                    if (dataMatches.matches && dataMatches.matches.length > 0) {
                        dataMatches.matches.sort((a, b) => new Date(a.startTime) - new Date(b.startTime));
                        const primerPartido = new Date(dataMatches.matches[0].startTime).getTime();

                        let timerDiv = document.getElementById('countdown-display');
                        let labelDiv = document.getElementById('countdown-label');

                        if (!labelDiv) {
                            labelDiv = document.createElement('div');
                            labelDiv.id = 'countdown-label';
                            labelDiv.textContent = "CIERRE DE PARTICIPACIONES:";
                            labelDiv.style.marginTop = '15px';
                            labelDiv.style.fontSize = '12px';
                            labelDiv.style.color = '#94a3b8';
                            labelDiv.style.letterSpacing = '1px';
                            labelDiv.style.fontWeight = 'bold';
                            labelDiv.style.textTransform = 'uppercase';
                            if (fechasEl && fechasEl.parentNode) fechasEl.parentNode.appendChild(labelDiv);
                        }

                        if (!timerDiv) {
                            timerDiv = document.createElement("div");
                            timerDiv.className = "stadium-clock";
                            timerDiv.id = 'countdown-display';
                            if (fechasEl && fechasEl.parentNode) fechasEl.parentNode.appendChild(timerDiv);
                        }

                        function actualizarTimer() {
                            const ahora = new Date().getTime();
                            const distancia = primerPartido - ahora;

                            if (distancia < 0) {
                                if (timerDiv) {
                                    timerDiv.innerHTML = "¬°CERRADO!";
                                    timerDiv.style.color = "#ef4444";
                                }
                                return;
                            }

                            const days = Math.floor(distancia / (1000 * 60 * 60 * 24));
                            const hours = Math.floor((distancia % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                            const minutes = Math.floor((distancia % (1000 * 60 * 60)) / (1000 * 60));
                            const seconds = Math.floor((distancia % (1000 * 60)) / 1000);

                            if (timerDiv) {
                                timerDiv.innerHTML = `‚è≥ ${days}d ${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                            }
                        }
                        actualizarTimer();
                        setInterval(actualizarTimer, 1000);
                    }
                } catch (e) { console.error(e); }

            } catch (error) { console.error(error); }
        }

        iniciarHeader();


        /* FILTRO PARTICIPANTES (GLOBAL) */
        function filtrarParticipantes() {
            const input = document.getElementById("filtroParticipantes");
            const filter = input.value.toUpperCase();
            const table = document.getElementById("tablaParticipantesBody");
            const tr = table.getElementsByTagName("tr");

            for (let i = 0; i < tr.length; i++) {
                const tdFolio = tr[i].getElementsByTagName("td")[0];

                if (tdFolio) {
                    const txtFolio = tdFolio.textContent || tdFolio.innerText;

                    if (txtFolio.toUpperCase().indexOf(filter) > -1) {
                        tr[i].style.display = "";
                    } else {
                        tr[i].style.display = "none";
                    }
                }
            }
        }

    </script>



    <!-- FOOTER GLOBAL UNIFICADO (Id√©ntico para todas las vistas) -->
    <footer
        style="width: 100%; margin-top: auto; text-align: center; padding: 30px 20px 180px 20px; color: #64748b; font-size: 14px; border-top: 1px solid rgba(255,255,255,0.05); background: rgba(0,0,0,0.4);">
        <!-- Copyright -->
        <div style="margin-bottom: 15px; color: #94a3b8;">
            &copy; 2026 Liga de Profetas. Todos los derechos reservados.
        </div>

        <!-- Disclaimer -->
        <p style="font-size: 12px; color: #475569; max-width: 800px; margin: 0 auto 20px auto; line-height: 1.5;">
            Liga de Profetas es una plataforma de concursos de predicci√≥n deportiva basada en la habilidad de los
            participantes. No constituye un casino ni sistema de juegos de azar.
        </p>

        <!-- Navigation -->
        <nav style="display: flex; justify-content: center; gap: 15px; flex-wrap: wrap; font-size: 13px;">
            <a href="terminos.html" style="color: #64748b; text-decoration: none; transition: color 0.2s;">T√©rminos y
                Condiciones</a>
            <span style="color: #334155;">|</span>
            <a href="privacidad.html" style="color: #64748b; text-decoration: none; transition: color 0.2s;">Aviso de
                Privacidad</a>
            <span style="color: #334155;">|</span>
            <a href="reglamento.html"
                style="color: #64748b; text-decoration: none; transition: color 0.2s;">Reglamento</a>
            <span style="color: #334155;">|</span>
            <a href="marco-legal.html" style="color: #64748b; text-decoration: none; transition: color 0.2s;">Marco
                Legal</a>
            <span style="color: #334155;">|</span>
            <a href="admin.html" style="color: var(--gold-primary); font-weight: bold; text-decoration: none;">Panel
                Admin</a>
        </nav>
        <style>
            nav a:hover {
                color: #fff !important;
                text-decoration: underline !important;
            }
        </style>
    </footer>

</body>

</html>